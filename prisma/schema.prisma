// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// SMF Member Groups
model SmfMembergroup {
  idGroup         Int      @id @map("id_group")
  groupName       String   @map("group_name") @db.VarChar(80)
  description     String?  @db.Text
  onlineColor     String?  @map("online_color") @db.VarChar(20)
  minPosts        Int      @map("min_posts") @default(-1)
  maxMessages     Int      @map("max_messages") @default(-1)
  stars           String?  @db.VarChar(255)
  groupType       Int      @map("group_type") @default(-1)

  // Relations
  members         SmfMember[]

  @@map("smf_membergroups")
}

// SMF Members (Users)
model SmfMember {
  idMember         Int      @id @default(autoincrement()) @map("id_member")
  memberName       String   @map("member_name") @db.VarChar(80)
  realName         String?  @map("real_name") @db.VarChar(255)
  emailAddress     String   @map("email_address") @db.VarChar(255)
  passwd           String   @db.VarChar(64)
  passwordSalt     String?  @map("password_salt") @db.VarChar(255)
  posts            Int      @default(0)
  dateRegistered   Int      @map("date_registered")
  lastLogin        Int?     @map("last_login")
  previousLogin    Int?     @map("previous_login")
  idGroup          Int      @map("id_group") @default(0)
  idPostGroup      Int?     @map("id_post_group")
  additionalGroups String?  @map("additional_groups") @db.VarChar(255)
  avatar           String?  @db.Text
  bannerImage      String?  @map("banner_image") @db.VarChar(500)
  signature        String?  @db.Text
  personalText     String?  @map("personal_text") @db.Text
  gender           Int?     @default(0)
  location         String?  @db.VarChar(255)
  websiteTitle     String?  @map("website_title") @db.VarChar(255)
  websiteUrl       String?  @map("website_url") @db.VarChar(255)
  birthdate        DateTime? @db.Date
  nbCritiques      Int      @default(0) @map("nb_critiques")
  nbSynopsis       Int      @default(0) @map("nb_synopsis")
  nbContributions  Int      @default(0) @map("nb_contributions")
  experience       Int      @default(0)
  instantMessages  Int      @default(0) @map("instant_messages")
  unreadMessages   Int      @default(0) @map("unread_messages")
  newPm            Int      @default(0) @map("new_pm")
  buddyList        String?  @map("buddy_list") @db.Text

  // Email verification
  emailVerified    Boolean  @default(false) @map("email_verified")
  emailVerifiedAt  DateTime? @map("email_verified_at") @db.Timestamptz

  // Relations
  membergroup      SmfMembergroup? @relation(fields: [idGroup], references: [idGroup])
  refreshTokens    AkRefreshToken[]
  passwordResetTokens AkPasswordResetToken[]
  emailVerificationTokens AkEmailVerificationToken[]
  reviews          AkCritique[]
  adminAuditLogs   AdminAuditLog[]
  animeCollections CollectionAnime[] @relation("UserAnimeCollection")
  mangaCollections CollectionManga[] @relation("UserMangaCollection")
  jeuxVideoCollections CollectionJeuxVideo[] @relation("UserJeuxVideoCollection")
  synopsisSubmissions AkSynopsis[]   @relation("UserSynopsis")
  listesTop        AkListesTop[]
  sentMessages     SmfPersonalMessage[] @relation("SentMessages")
  receivedMessages SmfPmRecipient[] @relation("ReceivedMessages")

  // Forum relations
  messages         SmfMessage[] @relation("MessageAuthor")
  startedTopics    SmfTopic[] @relation("TopicStarter")
  updatedTopics    SmfTopic[] @relation("TopicUpdater")
  reportsSubmitted SmfMessageReport[] @relation("ReportedBy")
  reportsClosed    SmfMessageReport[] @relation("ReportClosedBy")
  topicReadLogs    SmfLogTopics[]

  // Review reports relations
  reviewReportsSubmitted AkReviewReport[] @relation("ReportedBy")
  reviewReportsTreated   AkReviewReport[] @relation("TreatedBy")

  // RBAC relations
  userRoles              AkUserRole[] @relation("UserRoleAssignment")
  rolesGranted           AkRolePermission[] @relation(map: "ak_role_permissions_granted_by_fkey")
  rolesAssigned          AkUserRole[] @relation("RoleAssignedBy")
  roleAuditLogs          AkRoleAuditLog[] @relation("RoleAuditLog")

  @@index([idGroup])
  @@index([memberName])
  @@map("smf_members")
}

// SMF Member Logins - Track user login IPs
model SmfMemberLogin {
  idLogin   Int      @id @default(autoincrement()) @map("id_login")
  idMember  Int      @map("id_member") @default(0)
  time      Int      @default(0)
  ip        String   @default("") @db.VarChar(255)
  ip2       String   @default("") @db.VarChar(255)

  @@index([idMember, time])
  @@map("smf_member_logins")
}

// Refresh Tokens
model AkRefreshToken {
  id          Int       @id @default(autoincrement())
  token       String    @unique @db.VarChar(255)
  userId      Int       @map("user_id")
  expiresAt   DateTime  @map("expires_at") @db.Timestamptz
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz
  isRevoked   Boolean   @default(false) @map("is_revoked")
  deviceInfo  Json?     @map("device_info") @db.JsonB
  ipAddress   String?   @map("ip_address") @db.Inet
  userAgent   String?   @map("user_agent") @db.Text

  // Relations
  user        SmfMember @relation(fields: [userId], references: [idMember], onDelete: Cascade)

  @@map("ak_refresh_tokens")
}

// Password Reset Tokens
model AkPasswordResetToken {
  id          Int       @id @default(autoincrement())
  token       String    @unique @db.VarChar(255)
  userId      Int       @map("user_id")
  email       String    @db.VarChar(255)
  expiresAt   DateTime  @map("expires_at") @db.Timestamptz
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz
  usedAt      DateTime? @map("used_at") @db.Timestamptz
  isUsed      Boolean   @default(false) @map("is_used")
  ipAddress   String?   @map("ip_address") @db.Inet
  userAgent   String?   @map("user_agent") @db.Text

  // Relations
  user        SmfMember @relation(fields: [userId], references: [idMember], onDelete: Cascade)

  @@map("ak_password_reset_tokens")
}

// Email Verification Tokens
model AkEmailVerificationToken {
  id          Int       @id @default(autoincrement())
  token       String    @unique @db.VarChar(255)
  userId      Int       @map("user_id")
  email       String    @db.VarChar(255)
  expiresAt   DateTime  @map("expires_at") @db.Timestamptz
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz
  verifiedAt  DateTime? @map("verified_at") @db.Timestamptz
  isVerified  Boolean   @default(false) @map("is_verified")
  ipAddress   String?   @map("ip_address") @db.Inet
  userAgent   String?   @map("user_agent") @db.Text

  // Relations
  user        SmfMember @relation(fields: [userId], references: [idMember], onDelete: Cascade)

  @@map("ak_email_verification_tokens")
}

// Animes
model AkAnime {
  idAnime      Int       @id @default(autoincrement()) @map("id_anime")
  niceUrl      String?   @map("nice_url") @db.VarChar(255)
  titre        String    @db.VarChar(255)
  titreOrig    String?   @map("titre_orig") @db.Text
  // Legacy/title variants and metadata
  titreFr      String?   @map("titre_fr") @db.Text
  titresAlternatifs String? @map("titres_alternatifs") @db.Text
  annee        Int?
  dateDiffusion DateTime? @map("date_diffusion") @db.Date
  nbEp         Int?      @map("nb_ep")
  nbEpduree    String?   @map("nb_epduree") @db.VarChar(255)
  image        String?   @db.VarChar(255)
  studio       String?   @db.VarChar(100)
  dateAjout    DateTime? @map("date_ajout") @db.Timestamptz
  synopsis     String?   @db.Text
  statut       Int       @default(0)
  ficheComplete Int?     @default(0) @map("fiche_complete") @db.SmallInt
  realisateur  String?   @db.VarChar(255)
  nbReviews    Int?      @default(0) @map("nb_reviews")
  moyenneNotes Float?    @default(0) @map("moyennenotes") @db.Real
  format       String?   @db.VarChar(100)
  licence      Int?      @default(0)
  officialSite String?   @map("official_site") @db.VarChar(255)
  lienAdn      String?   @map("lien_adn") @db.VarChar(255)
  doublage     String?   @db.Text
  commentaire  String?   @db.Text
  sources      String?   @db.Text
  lienForum    Int?      @default(0) @map("lienforum")

  // Popularity ranking
  classementPopularite Int?     @default(0) @map("classement_popularite")
  variationPopularite  String?  @default("") @map("variation_popularite") @db.Text

  // Stats
  nbClics      Int?      @default(0) @map("nb_clics")
  nbClicsDay   Int?      @default(0) @map("nb_clics_day")
  nbClicsWeek  Int?      @default(0) @map("nb_clics_week")
  nbClicsMonth Int?      @default(0) @map("nb_clics_month")

  // Relations
  reviews      AkCritique[]
  episodes     AkAnimesEpisode[]
  trailers     AkAnimesTrailer[]
  businessRelations AkBusinessToAnime[]
  userCollections CollectionAnime[] @relation("UserAnimeList")
  articleRelations AkWebzineToFiches[] @relation("AnimeArticles")

  @@index([statut])
  @@index([dateAjout])
  @@index([licence])
  @@index([niceUrl])
  @@map("ak_animes")
}

// Anime Episodes
model AkAnimesEpisode {
  idEpisode    Int       @id @map("id_episode")
  idAnime      Int       @map("id_anime")
  numero       Int
  titre        String?   @db.VarChar(255)
  resume       String?   @db.Text
  dateAjout    DateTime? @map("date_ajout") @db.Timestamptz

  // Relations
  anime        AkAnime   @relation(fields: [idAnime], references: [idAnime], onDelete: Cascade)

  @@index([idAnime])
  @@index([idAnime, numero])
  @@map("ak_animes_episodes")
}

// Anime Trailers
model AkAnimesTrailer {
  idTrailer    Int       @id @default(autoincrement()) @map("id_trailer")
  idAnime      Int       @map("id_anime")
  titre        String?   @db.VarChar(255)
  url          String    @db.VarChar(500)
  platform     String?   @db.VarChar(50)
  langue       String?   @default("ja") @db.VarChar(10)
  typeTrailer  String?   @default("PV") @map("type_trailer") @db.VarChar(50)
  ordre        Int       @default(0)
  dateAjout    DateTime? @default(now()) @map("date_ajout") @db.Timestamptz
  statut       Int       @default(1) @db.SmallInt

  // Relations
  anime        AkAnime   @relation(fields: [idAnime], references: [idAnime], onDelete: Cascade)

  @@index([idAnime])
  @@index([statut])
  @@map("ak_animes_trailers")
}

// Mangas
model AkManga {
  idManga              Int       @id @default(autoincrement()) @map("id_manga")
  niceUrl              String?   @map("nice_url") @db.VarChar(255)
  titre                String    @db.Text
  auteur               String?   @db.Text
  annee                String?   @db.VarChar(4)
  origine              String?   @db.VarChar(255)
  titreOrig            String?   @map("titre_orig") @db.Text
  titreFr              String?   @map("titre_fr") @db.Text
  titresAlternatifs    String?   @map("titres_alternatifs") @db.Text
  licence              Int?      @default(0)
  nbVolumes            String?   @map("nb_volumes") @db.VarChar(255)
  nbVol                Int?      @map("nb_vol")
  statutVol            String?   @map("statut_vol") @db.VarChar(255)
  synopsis             String?   @db.Text
  image                String?   @db.VarChar(255)
  editeur              String?   @db.VarChar(255)
  isbn                 String?   @db.VarChar(255)
  precisions           String?   @db.Text
  tags                 String?   @db.Text
  nbClics              Int?      @default(0) @map("nb_clics")
  nbClicsDay           Int?      @default(0) @map("nb_clics_day")
  nbClicsWeek          Int?      @default(0) @map("nb_clics_week")
  nbClicsMonth         Int?      @default(0) @map("nb_clics_month")
  nbReviews            Int?      @default(0) @map("nb_reviews")
  label                Int?      @default(0)
  moyenneNotes         Float?    @default(0) @map("moyennenotes") @db.Real
  lienForum            Int?      @default(0) @map("lienforum")
  statut               Int       @default(0)
  ficheComplete        Int?      @default(0) @map("fiche_complete") @db.SmallInt
  dateAjout            DateTime  @default(now()) @map("date_ajout") @db.Timestamptz
  dateModification     Int?      @map("date_modification")
  latestCache          Int?      @map("latest_cache")
  classementPopularite Int?      @map("classement_popularite")
  variationPopularite  String?   @map("variation_popularite") @db.Text
  commentaire          String?   @db.Text

  // Relations
  reviews              AkCritique[]
  businessRelations    AkBusinessToManga[]
  userCollections      CollectionManga[] @relation("UserMangaList")
  volumes              MangaVolume[] @relation("MangaVolumes")
  articleRelations     AkWebzineToFiches[] @relation("MangaArticles")

  @@index([statut])
  @@index([dateAjout])
  @@index([licence])
  @@index([niceUrl])
  @@map("ak_mangas")
}

// Manga Volumes (Tomes)
model MangaVolume {
  idVolume      Int       @id @default(autoincrement()) @map("id_volume")
  idManga       Int       @map("id_manga")
  volumeNumber  Int       @map("volume_number")
  isbn          String?   @db.VarChar(13)
  coverImage    String?   @map("cover_image") @db.VarChar(255)
  title         String?   @db.VarChar(255)
  releaseDate   DateTime? @map("release_date") @db.Date
  description   String?   @db.Text
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  manga         AkManga   @relation("MangaVolumes", fields: [idManga], references: [idManga], onDelete: Cascade)

  @@unique([idManga, volumeNumber], name: "unique_manga_volume")
  @@unique([isbn], name: "unique_isbn")
  @@index([idManga])
  @@index([isbn])
  @@map("manga_volumes")
}

// Business entities (Studios, Authors, Publishers, etc.)
model AkBusiness {
  idBusiness            Int       @id @default(autoincrement()) @map("id_business")
  niceUrl               String?   @map("nice_url") @db.VarChar(255)
  type                  String?   @db.VarChar(255)
  denomination          String?   @unique @db.VarChar(255)
  autresDenominations   String?   @map("autres_denominations") @db.Text
  image                 String?   @db.VarChar(255)
  date                  String?   @db.VarChar(255)
  origine               String?   @db.VarChar(255)
  siteOfficiel          String?   @map("site_officiel") @db.VarChar(255)
  notes                 String?   @db.Text
  relations             Int?      @default(-1)
  nbClics               Int?      @default(0) @map("nb_clics")
  nbClicsDay            Int?      @map("nb_clics_day")
  nbClicsWeek           Int?      @map("nb_clics_week")
  nbClicsMonth          Int?      @map("nb_clics_month")
  statut                Int       @default(1)
  dateAjout             DateTime? @map("date_ajout") @db.Timestamptz
  dateModification      Int?      @map("date_modification")
  latestCache           Int?      @map("latest_cache")

  // Relations
  animeRelations        AkBusinessToAnime[]     @relation("BusinessToAnime")
  mangaRelations        AkBusinessToManga[]     @relation("BusinessToManga")
  jeuxVideoRelations    AkBusinessToJeux[]      @relation("BusinessToJeux")
  businessSourceRel     AkBusinessToBusiness[]  @relation("BusinessSource")
  businessRelatedRel    AkBusinessToBusiness[]  @relation("BusinessRelated")
  articleRelations      AkWebzineToFiches[]     @relation("BusinessArticles")

  @@map("ak_business")
}

// Video Games
model AkJeuxVideo {
  idJeu             Int       @id @default(autoincrement()) @map("id_jeu")
  niceUrl           String?   @map("nice_url") @db.VarChar(255)
  titre             String?   @db.Text
  image             String?   @db.VarChar(255)
  titreAlternatif   String?   @map("titre_alternatif") @db.Text
  annee             Int       @default(0)
  dateSortieJapon   DateTime? @map("date_sortie_japon") @db.Date
  dateSortieUsa     DateTime? @map("date_sortie_usa") @db.Date
  dateSortieEurope  DateTime? @map("date_sortie_europe") @db.Date
  dateSortieWorldwide DateTime? @map("date_sortie_worldwide") @db.Date
  genre             String?   @db.VarChar(255)
  developpeur       String?   @db.VarChar(255)
  editeur           String?   @db.VarChar(255)
  plateforme        String?   @db.VarChar(255)
  siteOfficiel      String?   @map("site_officiel") @db.VarChar(255)
  disponibilite     Int       @default(0)
  presentation      String?   @db.Text
  relations         String?   @db.Text
  label             Int       @default(0)
  nbReviews         Int       @default(0) @map("nb_reviews")
  moyenneNotes      Float     @default(0) @map("moyenne_notes") @db.Real
  nbClics           Int       @default(0) @map("nb_clics")
  nbClicsDay        Int       @map("nb_clics_day")
  nbClicsWeek       Int       @map("nb_clics_week")
  nbClicsMonth      Int       @map("nb_clics_month")
  lienForum         Int       @default(0) @map("lienforum")
  statut            Int       @default(1)
  playasia          String?   @db.Text
  dateAjout         DateTime  @default(now()) @map("date_ajout") @db.Timestamp
  dateModification  Int       @map("date_modification")
  moyennenotes      Float?    @db.Real
  latestCache       Int?      @map("latest_cache")
  igdbId            Int?      @map("igdb_id")

  // Relations
  platforms         AkJeuxVideoPlatform[]
  genres            AkJeuxVideoGenre[]
  trailers          AkJeuxVideoTrailer[]
  screenshots       AkJeuxVideoScreenshot[]
  collections       CollectionJeuxVideo[] @relation("UserJeuxVideoList")
  businessRelations AkBusinessToJeux[]
  reviews           AkCritique[]

  @@map("ak_jeux_video")
}

// Gaming Genres
model AkGenre {
  idGenre       Int       @id @default(autoincrement()) @map("id_genre")
  name          String    @unique @db.VarChar(100)
  nameFr        String?   @map("name_fr") @db.VarChar(100)
  slug          String    @unique @db.VarChar(100)
  sortOrder     Int       @default(0) @map("sort_order")
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamp

  // Relations
  jeuxVideoGenres AkJeuxVideoGenre[]

  @@map("ak_genres")
}

// Junction table for game-genre many-to-many relationship
model AkJeuxVideoGenre {
  idRelation    Int       @id @default(autoincrement()) @map("id_relation")
  idJeu         Int       @map("id_jeu")
  idGenre       Int       @map("id_genre")
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamp

  // Relations
  jeuVideo      AkJeuxVideo @relation(fields: [idJeu], references: [idJeu], onDelete: Cascade)
  genre         AkGenre     @relation(fields: [idGenre], references: [idGenre], onDelete: Restrict)

  @@unique([idJeu, idGenre])
  @@map("ak_jeux_video_genres")
}

// Gaming Platforms
model AkPlatform {
  idPlatform    Int       @id @default(autoincrement()) @map("id_platform")
  name          String    @unique @db.VarChar(100)
  shortName     String?   @map("short_name") @db.VarChar(20)
  manufacturer  String?   @db.VarChar(100)
  generation    String?   @db.VarChar(50)
  releaseYear   Int?      @map("release_year")
  platformType  String?   @map("platform_type") @db.VarChar(50)
  sortOrder     Int       @default(0) @map("sort_order")
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamp

  // Relations
  jeuxVideoPlatforms AkJeuxVideoPlatform[]

  @@map("ak_platforms")
}

// Junction table for game-platform many-to-many relationship
model AkJeuxVideoPlatform {
  idRelation    Int       @id @default(autoincrement()) @map("id_relation")
  idJeu         Int       @map("id_jeu")
  idPlatform    Int       @map("id_platform")
  releaseDate   DateTime? @map("release_date") @db.Date
  isPrimary     Boolean   @default(false) @map("is_primary")
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamp

  // Relations
  jeuVideo      AkJeuxVideo @relation(fields: [idJeu], references: [idJeu], onDelete: Cascade)
  platform      AkPlatform  @relation(fields: [idPlatform], references: [idPlatform], onDelete: Restrict)

  @@unique([idJeu, idPlatform])
  @@map("ak_jeux_video_platforms")
}

// Video Game Trailers
model AkJeuxVideoTrailer {
  idTrailer    Int       @id @default(autoincrement()) @map("id_trailer")
  idJeu        Int       @map("id_jeu")
  titre        String?   @db.VarChar(255)
  url          String    @db.VarChar(500)
  platform     String?   @db.VarChar(50)
  langue       String?   @default("en") @db.VarChar(10)
  typeTrailer  String?   @default("Trailer") @map("type_trailer") @db.VarChar(50)
  ordre        Int       @default(0)
  dateAjout    DateTime? @default(now()) @map("date_ajout") @db.Timestamptz
  statut       Int       @default(1) @db.SmallInt

  // Relations
  jeuVideo     AkJeuxVideo @relation(fields: [idJeu], references: [idJeu], onDelete: Cascade)

  @@index([idJeu])
  @@index([statut])
  @@map("ak_jeux_video_trailers")
}

model AkJeuxVideoScreenshot {
  id           Int       @id @default(autoincrement())
  filename     String?   @db.VarChar(255)
  caption      String?   @db.VarChar(255)
  sortorder    Int?
  createdat    DateTime? @db.Timestamp
  jeuVideoId   Int       @map("jeu_video_id")

  // Relations
  jeuVideo     AkJeuxVideo @relation(fields: [jeuVideoId], references: [idJeu], onDelete: Cascade)

  @@index([jeuVideoId])
  @@map("ak_jeux_video_screenshots")
}

// Anime/Manga Screenshots (polymorphic table - no FK constraints in DB)
model AkScreenshot {
  idScreen    Int       @id @default(autoincrement()) @map("id_screen")
  urlScreen   String?   @map("url_screen") @db.VarChar(255)
  idTitre     Int       @map("id_titre")
  type        Int       @default(1) // 1 = anime, 2 = manga
  uploadDate  DateTime? @default(now()) @map("upload_date") @db.Timestamp

  @@index([idTitre])
  @@index([idTitre, type])
  @@map("ak_screenshots")
}

// Business to Anime Relations
model AkBusinessToAnime {
  idRelation  Int       @id @default(autoincrement()) @map("id_relation")
  idAnime     Int?      @map("id_anime")
  idBusiness  Int?      @map("id_business")
  type        String?   @db.VarChar(100)
  precisions  String?   @db.Text
  doublon     Int?      @db.SmallInt

  // Relations
  anime       AkAnime?  @relation(fields: [idAnime], references: [idAnime], onDelete: Cascade)
  business    AkBusiness? @relation("BusinessToAnime", fields: [idBusiness], references: [idBusiness], onDelete: Cascade)

  @@map("ak_business_to_animes")
}

// Business to Manga Relations
model AkBusinessToManga {
  idRelation  Int       @id @default(autoincrement()) @map("id_relation")
  idManga     Int?      @map("id_manga")
  idBusiness  Int?      @map("id_business")
  type        String?   @db.VarChar(100)
  precisions  String?   @db.Text
  doublon     Int?      @db.SmallInt

  // Relations
  manga       AkManga?  @relation(fields: [idManga], references: [idManga], onDelete: Cascade)
  business    AkBusiness? @relation("BusinessToManga", fields: [idBusiness], references: [idBusiness], onDelete: Cascade)

  @@map("ak_business_to_mangas")
}

// Business to Jeux Video Relations
model AkBusinessToJeux {
  idRelation  Int         @id @default(autoincrement()) @map("id_relation")
  idJeu       Int         @map("id_jeu")
  idBusiness  Int         @map("id_business")
  type        String?     @db.VarChar(100)

  // Relations
  jeuVideo    AkJeuxVideo @relation(fields: [idJeu], references: [idJeu], onDelete: Cascade)
  business    AkBusiness  @relation("BusinessToJeux", fields: [idBusiness], references: [idBusiness], onDelete: Cascade)

  @@map("ak_business_to_jeux")
}

model AkBusinessToBusiness {
  idRelation        Int         @id @default(autoincrement()) @map("id_relation")
  idBusinessSource  Int?        @map("id_business_source")
  idBusinessRelated Int?        @map("id_business_related")
  type              String?     @db.VarChar(100)
  precisions        String?     @db.Text
  doublon           Int?        @default(0) @db.SmallInt

  // Relations
  businessSource  AkBusiness? @relation("BusinessSource", fields: [idBusinessSource], references: [idBusiness], onDelete: Cascade)
  businessRelated AkBusiness? @relation("BusinessRelated", fields: [idBusinessRelated], references: [idBusiness], onDelete: Cascade)

  @@map("ak_business_to_business")
}

// User Lists/Tops
model AkListesTop {
  idListe       Int       @id @default(autoincrement()) @map("id_liste")
  niceUrl       String    @map("nice_url") @db.VarChar(255)
  titre         String?   @db.Text
  presentation  String?   @db.Text
  type          String?   @db.VarChar(10) // 'liste' | 'top'
  animeOrManga  String?   @map("anime_or_manga") @db.VarChar(10) // 'anime' | 'manga' | 'jeu-video'
  jsonData      String?   @map("json_data") @db.Text // JSON string of IDs e.g. ["173","65",...]
  jsonDataCom   String?   @map("json_data_com") @db.Text // Comments per item
  jaime         String?   @db.Text // CSV user IDs
  jaimepas      String?   @db.Text // CSV user IDs
  popularite    Float?    @db.Real
  score         Int       @default(0)
  nbClics       Int       @default(0) @map("nb_clics")
  statut        Int       @default(0) // 0=draft,1=published
  idMembre      Int       @map("id_membre")
  dateCreation  DateTime? @map("date_creation") @db.Timestamp

  // Relations
  membre        SmfMember @relation(fields: [idMembre], references: [idMember], onDelete: Cascade)

  @@map("ak_listes_top")
}

// Reviews/Critiques
model AkCritique {
  idCritique   Int       @id @default(autoincrement()) @map("id_critique")
  niceUrl      String?   @map("nice_url") @db.VarChar(255)
  titre        String?   @db.Text
  critique     String?   @db.Text
  notation     Int?      @default(0)
  dateCritique DateTime? @map("date_critique") @db.Timestamp
  statut       Int       @default(0)
  questions    String?   @db.Text
  acceptImages Int?      @map("accept_images")
  evaluation   String?   @db.Text
  idMembre     Int       @default(0) @map("id_membre")
  idAnime      Int       @default(0) @map("id_anime")
  idManga      Int       @default(0) @map("id_manga")
  idOst        Int       @default(0) @map("id_ost")
  idJeu        Int       @default(0) @map("id_jeu")
  causeSuppr   String?   @map("cause_suppr") @db.Text
  nbClics      Int?      @default(0) @map("nb_clics")
  nbClicsDay   Int?      @default(0) @map("nb_clics_day")
  nbClicsWeek  Int?      @default(0) @map("nb_clics_week")
  nbClicsMonth Int?      @default(0) @map("nb_clics_month")
  nbCarac      Int?      @map("nb_carac")
  popularite   Float?    @db.Real
  classementPopularite Int? @map("classement_popularite")
  variationPopularite String? @map("variation_popularite") @db.Text

  // Relations
  membre       SmfMember? @relation(fields: [idMembre], references: [idMember], onDelete: Cascade)
  anime        AkAnime?  @relation(fields: [idAnime], references: [idAnime], onDelete: Cascade)
  manga        AkManga?  @relation(fields: [idManga], references: [idManga], onDelete: Cascade)
  jeuxVideo    AkJeuxVideo? @relation(fields: [idJeu], references: [idJeu], onDelete: Cascade)
  reports      AkReviewReport[]

  @@index([idMembre])
  @@index([idAnime])
  @@index([idManga])
  @@index([idJeu])
  @@index([statut])
  @@index([dateCritique])
  @@map("ak_critique")
}

// Content Relations (Anime/Manga to Anime/Manga)
model AkFicheToFiche {
  idRelation    Int    @id @default(autoincrement()) @map("id_relation")
  idFicheDepart String @map("id_fiche_depart") @db.VarChar(100)
  idAnime       Int    @default(0) @map("id_anime")
  idManga       Int    @default(0) @map("id_manga")
  idOst         Int    @default(0) @map("id_ost")
  idJeu         Int    @default(0) @map("id_jeu")
  idBusiness    Int    @default(0) @map("id_business")

  @@map("ak_fiche_to_fiche")
}

// Admin Audit Log
model AdminAuditLog {
  id          Int       @id @default(autoincrement())
  adminId     Int       @map("admin_id")
  action      String    @db.VarChar(100)
  targetType  String    @map("target_type") @db.VarChar(50)
  targetId    Int?      @map("target_id")
  reason      String?   @db.Text
  metadata    Json?     @db.JsonB
  ipAddress   String?   @map("ip_address") @db.Inet
  userAgent   String?   @map("user_agent") @db.Text
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  admin       SmfMember @relation(fields: [adminId], references: [idMember], onDelete: Cascade)

  @@map("admin_audit_log")
}

// Articles System Models

// WordPress Posts (Webzine Articles)
model WpPost {
  ID                    BigInt    @id @default(autoincrement())
  postAuthor           BigInt?   @map("post_author")
  postDate             DateTime  @map("post_date") @db.Timestamp
  postDateGmt          DateTime  @map("post_date_gmt") @db.Timestamp
  postContent          String?   @map("post_content") @db.Text
  postTitle            String    @map("post_title") @db.Text
  postExcerpt          String?   @map("post_excerpt") @db.Text
  postStatus           String    @map("post_status") @db.VarChar(20) @default("publish")
  commentStatus        String    @map("comment_status") @db.VarChar(20) @default("open")
  pingStatus           String    @map("ping_status") @db.VarChar(20) @default("open")
  postPassword         String    @map("post_password") @db.VarChar(255) @default("")
  postName             String    @map("post_name") @db.VarChar(200) @default("")
  toPing               String?   @map("to_ping") @db.Text
  pinged               String?   @db.Text
  postModified         DateTime  @map("post_modified") @db.Timestamp
  postModifiedGmt      DateTime  @map("post_modified_gmt") @db.Timestamp
  postContentFiltered  String?   @map("post_content_filtered") @db.Text
  postParent           Int       @map("post_parent") @default(0)
  guid                 String    @db.VarChar(255) @default("")
  menuOrder            Int       @map("menu_order") @default(0)
  postType             String    @map("post_type") @db.VarChar(20) @default("post")
  postMimeType         String    @map("post_mime_type") @db.VarChar(100) @default("")
  commentCount         Int       @map("comment_count") @default(0)

  // Relations
  wpAuthor             WpUser? @relation(fields: [postAuthor], references: [ID], onDelete: SetNull)
  comments             WpComment[]
  postMeta             WpPostMeta[]
  termRelationships    WpTermRelationship[]
  images               AkWebzineImg[]
  ficheRelations       AkWebzineToFiches[]

  @@map("wp_posts")
}

// WordPress Comments
model WpComment {
  commentID           BigInt    @id @default(autoincrement()) @map("comment_ID")
  commentPostID       BigInt    @map("comment_post_ID")
  commentAuthor       String?   @map("comment_author") @db.Text
  commentAuthorEmail  String?   @map("comment_author_email") @db.VarChar(100)
  commentAuthorUrl    String?   @map("comment_author_url") @db.VarChar(200)
  commentAuthorIP     String?   @map("comment_author_IP") @db.VarChar(100)
  commentDate         DateTime  @map("comment_date") @db.Timestamp
  commentDateGmt      DateTime  @map("comment_date_gmt") @db.Timestamp
  commentContent      String?   @map("comment_content") @db.Text
  commentKarma        Int       @map("comment_karma") @default(0)
  commentApproved     String    @map("comment_approved") @db.VarChar(20) @default("1")
  commentAgent        String?   @map("comment_agent") @db.VarChar(255)
  commentType         String?   @map("comment_type") @db.VarChar(20) @default("comment")
  commentParent       BigInt    @map("comment_parent") @default(0)
  userId              Int       @map("user_id") @default(0)

  // Relations
  post                WpPost    @relation(fields: [commentPostID], references: [ID], onDelete: Cascade)

  @@map("wp_comments")
}

// WordPress Post Meta
model WpPostMeta {
  metaId              BigInt    @id @default(autoincrement()) @map("meta_id")
  postId              BigInt    @map("post_id")
  metaKey             String?   @map("meta_key") @db.VarChar(255)
  metaValue           String?   @map("meta_value") @db.Text

  // Relations
  post                WpPost    @relation(fields: [postId], references: [ID], onDelete: Cascade)

  @@map("wp_postmeta")
}

// WordPress Terms (Categories/Tags)
model WpTerm {
  termId              Int       @id @default(autoincrement()) @map("term_id")
  name                String    @db.VarChar(200)
  slug                String    @db.VarChar(200)
  termGroup           Int       @map("term_group") @default(0)

  // Relations
  termTaxonomies      WpTermTaxonomy[]

  @@map("wp_terms")
}

// WordPress Term Taxonomy
model WpTermTaxonomy {
  termTaxonomyId      Int       @id @default(autoincrement()) @map("term_taxonomy_id")
  termId              Int       @map("term_id")
  taxonomy            String    @db.VarChar(32)
  description         String?   @db.Text
  parent              Int       @default(0)
  count               Int       @default(0)

  // Relations
  term                WpTerm    @relation(fields: [termId], references: [termId], onDelete: Cascade)
  termRelationships   WpTermRelationship[]

  @@map("wp_term_taxonomy")
}

// WordPress Term Relationships
model WpTermRelationship {
  objectId            BigInt    @map("object_id")
  termTaxonomyId      Int       @map("term_taxonomy_id")
  termOrder           Int       @map("term_order") @default(0)

  // Relations
  post                WpPost    @relation(fields: [objectId], references: [ID], onDelete: Cascade)
  termTaxonomy        WpTermTaxonomy @relation(fields: [termTaxonomyId], references: [termTaxonomyId], onDelete: Cascade)

  @@id([objectId, termTaxonomyId])
  @@map("wp_term_relationships")
}

// WordPress Users
model WpUser {
  ID                  BigInt    @id @default(autoincrement()) @map("ID")
  userLogin           String    @unique @map("user_login") @db.VarChar(60)
  userPass            String    @map("user_pass") @db.VarChar(255)
  userNicename        String    @map("user_nicename") @db.VarChar(50)
  userEmail           String    @map("user_email") @db.VarChar(100)
  userUrl             String?   @map("user_url") @db.VarChar(100)
  userRegistered      DateTime  @map("user_registered") @db.Timestamp
  userActivationKey   String?   @map("user_activation_key") @db.VarChar(255)
  userStatus          Int       @map("user_status") @default(0)
  displayName         String    @map("display_name") @db.VarChar(250)

  // Relations
  posts                WpPost[]

  @@map("wp_users")
}

// Adapted Existing Collections (now support named collections)
model CollectionAnime {
  idCollection     Int       @id @default(autoincrement()) @map("id_collection")
  type             Int       @default(0)
  idMembre         Int       @default(0) @map("id_membre")
  idAnime          Int       @default(0) @map("id_anime")
  evaluation       Decimal   @map("evaluation") @db.Decimal(3, 1)
  notes            String?   @db.Text
  doublon          Int?      @default(0) @db.SmallInt

  // New fields for named collections
  collectionName   String?   @map("collection_name") @db.VarChar(100)
  isPublic         Boolean   @default(true) @map("is_public")
  createdAt        DateTime? @default(now()) @map("created_at") @db.Timestamptz
  updatedAt        DateTime? @default(now()) @map("updated_at") @db.Timestamptz

  // Relations
  user             SmfMember @relation("UserAnimeCollection", fields: [idMembre], references: [idMember], onDelete: Cascade)
  anime            AkAnime   @relation("UserAnimeList", fields: [idAnime], references: [idAnime], onDelete: Cascade)

  @@index([idMembre])
  @@index([idAnime])
  @@index([idMembre, idAnime])
  @@index([idMembre, type])
  @@index([createdAt])
  @@map("collection_animes")
}

model CollectionManga {
  idCollection     Int       @id @default(autoincrement()) @map("id_collection")
  type             Int       @default(0)
  idMembre         Int       @default(0) @map("id_membre")
  idManga          Int       @default(0) @map("id_manga")
  evaluation       Decimal   @map("evaluation") @db.Decimal(3, 1)
  notes            String?   @db.Text
  doublon          Int?      @default(0) @db.SmallInt

  // New fields for named collections
  collectionName   String?   @map("collection_name") @db.VarChar(100)
  isPublic         Boolean   @default(true) @map("is_public")
  createdAt        DateTime? @default(now()) @map("created_at") @db.Timestamptz
  updatedAt        DateTime? @default(now()) @map("updated_at") @db.Timestamptz

  // Relations
  user             SmfMember @relation("UserMangaCollection", fields: [idMembre], references: [idMember], onDelete: Cascade)
  manga            AkManga   @relation("UserMangaList", fields: [idManga], references: [idManga], onDelete: Cascade)

  @@index([idMembre])
  @@index([idManga])
  @@index([idMembre, idManga])
  @@index([idMembre, type])
  @@index([createdAt])
  @@map("collection_mangas")
}

model CollectionJeuxVideo {
  idCollection       Int       @id @default(autoincrement()) @map("id_collection")
  type               Int       @default(0)
  idMembre           Int       @default(0) @map("id_membre")
  idJeu              Int       @default(0) @map("id_jeu")
  evaluation         Decimal   @map("evaluation") @db.Decimal(3, 1)
  notes              String?   @db.Text
  doublon            Int?      @default(0) @db.SmallInt
  liked              Boolean?  @default(false)
  mastered           Boolean?  @default(false)
  platformPlayed     String?   @map("platform_played") @db.VarChar(255)
  physicalPlatform   String?   @map("physical_platform") @db.VarChar(255)
  startedDate        DateTime? @map("started_date") @db.Date
  finishedDate       DateTime? @map("finished_date") @db.Date
  logTitle           String?   @default("Log") @map("log_title") @db.VarChar(100)
  isReplay           Boolean?  @default(false) @map("is_replay")
  timePlayedHours    Int?      @default(0) @map("time_played_hours")
  timePlayedMinutes  Int?      @default(0) @map("time_played_minutes")
  useSessionsTime    Boolean?  @default(false) @map("use_sessions_time")
  ownershipType      String?   @map("ownership_type") @db.VarChar(50)
  storefront         String?   @db.VarChar(100)
  containsSpoilers   Boolean?  @default(false) @map("contains_spoilers")
  dateCreated        DateTime? @default(now()) @map("date_created") @db.Timestamp
  dateModified       DateTime? @default(now()) @map("date_modified") @db.Timestamp

  // Relations
  user               SmfMember     @relation("UserJeuxVideoCollection", fields: [idMembre], references: [idMember], onDelete: Cascade)
  jeuxVideo          AkJeuxVideo   @relation("UserJeuxVideoList", fields: [idJeu], references: [idJeu], onDelete: Cascade)

  @@unique([idMembre, idJeu], name: "unique_user_game")
  @@index([idMembre])
  @@index([idJeu])
  @@index([idMembre, idJeu])
  @@index([idMembre, type])
  @@index([dateCreated])
  @@map("collection_jeuxvideo")
}

// Synopsis submissions
model AkSynopsis {
  idSynopsis   Int       @id @default(autoincrement()) @map("id_synopsis")
  date         DateTime  @default(now()) @db.Timestamp
  idMembre     Int       @default(0) @map("id_membre")
  synopsis     String?   @db.Text
  type         Int       @default(0) // 1 = anime, 2 = manga
  validation   Int       @default(0) // 0 = pending, 1 = approved, 2 = rejected
  idFiche      Int?      @default(0) @map("id_fiche")

  // Relations
  user         SmfMember @relation("UserSynopsis", fields: [idMembre], references: [idMember], onDelete: Cascade)

  @@map("ak_synopsis")
}

// Anime Seasons
model AkAnimesSaisons {
  idSaison     Int    @id @default(autoincrement()) @map("id_saison")
  saison       Int    @db.SmallInt
  annee        Int
  idArticle    Int    @map("id_article")
  jsonData     String @map("json_data") @db.Text
  jsonAuteurs  String @map("json_auteurs") @db.VarChar(255)
  statut       Int?   @default(0) @db.SmallInt

  @@map("ak_animes_saisons")
}

// Webzine Article Images
model AkWebzineImg {
  idImg        Int     @id @default(autoincrement()) @map("id_img")
  idArt        BigInt  @map("id_art")
  urlImg       String? @map("url_img") @db.VarChar(255)

  // Relations
  article      WpPost  @relation(fields: [idArt], references: [ID], onDelete: Cascade)

  @@map("ak_webzine_img")
}

// Webzine to Fiches (Articles linked to Anime/Manga/Business)
model AkWebzineToFiches {
  idRelation   Int    @id @default(autoincrement()) @map("id_relation")
  idArticle    Int    @default(0) @map("id_article") // For legacy ak_webzine_articles (unused)
  idWpArticle  BigInt @default(0) @map("id_wp_article") // WordPress post ID
  idFiche      Int    @map("id_fiche") // anime/manga/business ID
  type         String @db.VarChar(50) // 'anime', 'manga', or 'business'

  // Relations
  wpPost       WpPost?     @relation(fields: [idWpArticle], references: [ID], onDelete: Cascade)
  anime        AkAnime?    @relation("AnimeArticles", fields: [idFiche], references: [idAnime], onDelete: Cascade, map: "ak_webzine_to_fiches_anime_fkey")
  manga        AkManga?    @relation("MangaArticles", fields: [idFiche], references: [idManga], onDelete: Cascade, map: "ak_webzine_to_fiches_manga_fkey")
  business     AkBusiness? @relation("BusinessArticles", fields: [idFiche], references: [idBusiness], onDelete: Cascade, map: "ak_webzine_to_fiches_business_fkey")

  @@unique([idFiche, idWpArticle, type])
  @@index([idFiche, type])
  @@index([idWpArticle])
  @@map("ak_webzine_to_fiches")
}

// SMF Private Messages
model SmfPersonalMessage {
  idPm            Int      @id @default(autoincrement()) @map("id_pm")
  idPmHead        Int      @map("id_pm_head") @default(0)
  idMemberFrom    Int      @map("id_member_from")
  fromName        String   @map("from_name") @db.VarChar(255)
  msgtime         Int
  subject         String   @db.VarChar(255)
  body            String   @db.Text
  deletedBySender Int      @default(0) @map("deleted_by_sender")
  conversationUrl String?  @map("conversation_url") @db.VarChar(500)

  // Relations
  sender          SmfMember @relation("SentMessages", fields: [idMemberFrom], references: [idMember], onDelete: Cascade)
  recipients      SmfPmRecipient[]

  @@map("smf_personal_messages")
}

// SMF PM Recipients
model SmfPmRecipient {
  idPm        Int  @map("id_pm")
  idMember    Int  @map("id_member")
  bcc         Int  @default(0)
  isRead      Int  @default(0) @map("is_read")
  isNew       Int  @default(1) @map("is_new")
  deleted     Int  @default(0)
  isImportant Int  @default(0) @map("is_important")

  // Relations
  message   SmfPersonalMessage @relation(fields: [idPm], references: [idPm], onDelete: Cascade)
  member    SmfMember @relation("ReceivedMessages", fields: [idMember], references: [idMember], onDelete: Cascade)

  @@id([idPm, idMember])
  @@index([isImportant])
  @@map("smf_pm_recipients")
}

// SMF Categories
model SmfCategory {
  idCat      Int      @id @map("id_cat")
  catOrder   Int      @map("cat_order") @default(0)
  name       String   @db.VarChar(255)
  canCollapse Int     @map("can_collapse") @default(1)

  // Relations
  boards     SmfBoard[]

  @@index([catOrder])
  @@map("smf_categories")
}

// SMF Boards/Forums
model SmfBoard {
  idBoard          Int      @id @map("id_board")
  idCat            Int      @map("id_cat")
  childLevel       Int      @map("child_level") @default(0)
  idParent         Int      @map("id_parent") @default(0)
  boardOrder       Int      @map("board_order") @default(0)
  idLastMsg        Int      @map("id_last_msg") @default(0)
  idMsgUpdated     Int      @map("id_msg_updated") @default(0)
  memberGroups     String   @map("member_groups") @default("-1,0") @db.VarChar(255)
  idProfile        Int      @map("id_profile") @default(1)
  name             String   @db.VarChar(255)
  description      String?  @db.Text
  numTopics        Int      @map("num_topics") @default(0)
  numPosts         Int      @map("num_posts") @default(0)
  countPosts       Int      @map("count_posts") @default(0)
  idTheme          Int      @map("id_theme") @default(0)
  override_theme   Int      @map("override_theme") @default(0)
  redirect         String?  @db.VarChar(255)

  // Relations
  category       SmfCategory @relation(fields: [idCat], references: [idCat], onDelete: Cascade)
  topics         SmfTopic[]
  messages       SmfMessage[]

  @@index([idCat])
  @@index([idLastMsg])
  @@index([idParent])
  @@index([boardOrder])
  @@map("smf_boards")
}

// SMF Topics
model SmfTopic {
  idTopic          Int      @id @map("id_topic")
  isSticky         Int      @map("is_sticky") @default(0)
  idBoard          Int      @map("id_board")
  idFirstMsg       Int      @map("id_first_msg") @default(0)
  idLastMsg        Int      @map("id_last_msg") @default(0)
  idMemberStarted  Int      @map("id_member_started") @default(0)
  idMemberUpdated  Int      @map("id_member_updated") @default(0)
  idPoll           Int      @map("id_poll") @default(0)
  idPreviousBoard  Int      @map("id_previous_board") @default(0)
  idPreviousTopic  Int      @map("id_previous_topic") @default(0)
  numReplies       Int      @map("num_replies") @default(0)
  numViews         Int      @map("num_views") @default(0)
  locked           Int      @default(0)
  approved         Int      @default(1)
  unapprovedPosts  Int      @map("unapproved_posts") @default(0)

  // Relations
  board            SmfBoard @relation(fields: [idBoard], references: [idBoard], onDelete: Cascade)
  messages         SmfMessage[]
  poll             SmfPoll? @relation(fields: [idPoll], references: [idPoll])
  readLogs         SmfLogTopics[]

  // Computed relations for convenience
  firstMessage     SmfMessage? @relation("TopicFirstMessage", fields: [idFirstMsg], references: [idMsg])
  lastMessage      SmfMessage? @relation("TopicLastMessage", fields: [idLastMsg], references: [idMsg])
  starter          SmfMember?  @relation("TopicStarter", fields: [idMemberStarted], references: [idMember])
  lastUpdater      SmfMember?  @relation("TopicUpdater", fields: [idMemberUpdated], references: [idMember])

  @@index([idBoard])
  @@index([idFirstMsg])
  @@index([idLastMsg])
  @@map("smf_topics")
}

// SMF Messages/Posts
model SmfMessage {
  idMsg         Int      @id @map("id_msg")
  idTopic       Int      @map("id_topic")
  idBoard       Int      @map("id_board")
  posterTime    Int      @map("poster_time")
  idMember      Int      @map("id_member") @default(0)
  idMsgModified Int      @map("id_msg_modified") @default(0)
  subject       String   @db.VarChar(255)
  posterName    String   @map("poster_name") @db.VarChar(255)
  posterEmail   String?  @map("poster_email") @db.VarChar(255)
  posterIp      String?  @map("poster_ip") @db.VarChar(255)
  smileysEnabled Int     @map("smileys_enabled") @default(1)
  modifiedTime  Int      @map("modified_time") @default(0)
  modifiedName  String?  @map("modified_name") @db.VarChar(255)
  body          String   @db.Text
  icon          String   @db.VarChar(16) @default("xx")
  approved      Int      @default(1)

  // Relations
  topic         SmfTopic @relation(fields: [idTopic], references: [idTopic], onDelete: Cascade)
  board         SmfBoard @relation(fields: [idBoard], references: [idBoard], onDelete: Cascade)
  member        SmfMember? @relation("MessageAuthor", fields: [idMember], references: [idMember])

  // Reverse relations for first/last message lookups
  topicsAsFirst SmfTopic[] @relation("TopicFirstMessage")
  topicsAsLast  SmfTopic[] @relation("TopicLastMessage")
  reports       SmfMessageReport[]

  @@index([idTopic])
  @@index([idBoard])
  @@index([posterTime])
  @@index([idMember])
  @@map("smf_messages")
}

// SMF Message Reports
model SmfMessageReport {
  idReport    Int      @id @default(autoincrement()) @map("id_report")
  idMsg       Int      @map("id_msg")
  idMember    Int      @map("id_member")
  comment     String   @db.Text
  timeStarted Int      @map("time_started")
  closed      Int      @default(0) // 0 = open, 1 = closed/resolved
  closedBy    Int?     @map("closed_by")
  timeClose   Int?     @map("time_closed")

  // Relations
  message     SmfMessage @relation(fields: [idMsg], references: [idMsg], onDelete: Cascade)
  reporter    SmfMember  @relation("ReportedBy", fields: [idMember], references: [idMember], onDelete: Cascade)
  closer      SmfMember? @relation("ReportClosedBy", fields: [closedBy], references: [idMember], onDelete: SetNull)

  @@map("smf_message_reports")
}

// SMF Polls
model SmfPoll {
  idPoll          Int       @id @map("id_poll")
  question        String    @db.VarChar(255)
  votingLocked    Int       @map("voting_locked") @default(0) // 0=open, 1=locked by user, 2=locked by moderator
  maxVotes        Int       @map("max_votes") @default(1)
  expireTime      Int       @map("expire_time") @default(0)
  hideResults     Int       @map("hide_results") @default(0)
  changeVote      Int       @map("change_vote") @default(0)
  guestVote       Int       @map("guest_vote") @default(0)
  numGuestVoters  Int       @map("num_guest_voters") @default(0)
  resetPoll       Int       @map("reset_poll") @default(0)
  idMember        Int       @map("id_member") @default(0)
  posterName      String    @map("poster_name") @db.VarChar(255)

  // Relations
  choices         SmfPollChoice[]
  votes           SmfLogPoll[]
  topics          SmfTopic[]

  @@map("smf_polls")
}

// SMF Poll Choices
model SmfPollChoice {
  idPoll    Int    @map("id_poll")
  idChoice  Int    @map("id_choice")
  label     String @db.VarChar(255)
  votes     Int    @default(0)

  // Relations
  poll      SmfPoll @relation(fields: [idPoll], references: [idPoll], onDelete: Cascade)

  @@id([idPoll, idChoice])
  @@map("smf_poll_choices")
}

// SMF Poll Vote Log
model SmfLogPoll {
  idPoll    Int @map("id_poll")
  idMember  Int @map("id_member")
  idChoice  Int @map("id_choice")

  // Relations
  poll      SmfPoll @relation(fields: [idPoll], references: [idPoll], onDelete: Cascade)

  @@id([idPoll, idMember, idChoice])
  @@index([idPoll, idMember, idChoice])
  @@map("smf_log_polls")
}

// SMF Topic Read Tracking Log
model SmfLogTopics {
  idTopic   Int @map("id_topic")
  idMember  Int @map("id_member")
  idMsg     Int @map("id_msg") @default(0)

  // Relations
  topic     SmfTopic @relation(fields: [idTopic], references: [idTopic], onDelete: Cascade)
  member    SmfMember @relation(fields: [idMember], references: [idMember], onDelete: Cascade)

  @@id([idTopic, idMember])
  @@index([idMember])
  @@map("smf_log_topics")
}

// SMF Online Activity Log
model SmfLogOnline {
  session   String  @id @db.VarChar(128)
  logTime   Int     @map("log_time")
  idMember  Int     @map("id_member") @default(0)
  idSpider  Int     @map("id_spider") @default(0)
  ip        String? @db.VarChar(45)
  url       String  @db.VarChar(2048) @default("")

  // Note: No foreign key to smf_members because guests have id_member = 0
  // which doesn't exist in the members table

  @@index([logTime])
  @@index([idMember])
  @@map("smf_log_online")
}

// Tags
model AkTag {
  idTag       Int     @id @default(autoincrement()) @map("id_tag")
  tagName     String? @map("tag_name") @db.VarChar(100)
  tagNiceUrl  String? @map("tag_nice_url") @db.VarChar(100)
  description String? @db.Text
  categorie   String? @db.VarChar(100)

  @@map("ak_tags")
}

// Review Reports (Signalements de critiques)
model AkReviewReport {
  idReport      Int       @id @default(autoincrement()) @map("id_report")
  idCritique    Int       @map("id_critique")
  idReporter    Int       @map("id_reporter")
  reason        String    @db.VarChar(100)  // Type de signalement
  comment       String?   @db.Text          // Commentaire optionnel
  status        Int       @default(0)       // 0 = en attente, 1 = trait, 2 = rejet
  dateReport    DateTime  @default(now()) @map("date_report") @db.Timestamp
  dateTreated   DateTime? @map("date_treated") @db.Timestamp
  idModerator   Int?      @map("id_moderator") // Qui a trait le signalement
  moderatorNote String?   @map("moderator_note") @db.Text

  // Relations
  critique      AkCritique @relation(fields: [idCritique], references: [idCritique], onDelete: Cascade)
  reporter      SmfMember  @relation("ReportedBy", fields: [idReporter], references: [idMember], onDelete: Cascade)
  moderator     SmfMember? @relation("TreatedBy", fields: [idModerator], references: [idMember], onDelete: SetNull)

  @@index([idCritique])
  @@index([idReporter])
  @@index([status])
  @@map("ak_review_reports")
}

// ============================================================================
// ROLE-BASED ACCESS CONTROL (RBAC) SYSTEM
// ============================================================================
// Add these models to the end of schema.prisma

// Custom Roles (extends SMF member groups)
model AkRole {
  idRole      Int       @id @default(autoincrement()) @map("id_role")
  roleName    String    @unique @map("role_name") @db.VarChar(100)
  displayName String    @map("display_name") @db.VarChar(100)
  description String?   @db.Text
  color       String?   @db.VarChar(20)  // Hex color for UI display
  priority    Int       @default(0)       // Higher priority = more important role
  isSystem    Boolean   @default(false) @map("is_system")  // System roles cannot be deleted
  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamp
  updatedAt   DateTime  @updatedAt @map("updated_at") @db.Timestamp

  // Relations
  rolePermissions AkRolePermission[]
  userRoles       AkUserRole[]

  @@index([roleName])
  @@index([isActive])
  @@map("ak_roles")
}

// Permissions (resource + action combinations)
model AkPermission {
  idPermission Int      @id @default(autoincrement()) @map("id_permission")
  resource     String   @db.VarChar(50)  // ARTICLES, ANIME, MANGA, etc.
  action       String   @db.VarChar(50)  // CREATE, READ, UPDATE, DELETE, MODERATE, etc.
  description  String?  @db.Text
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamp

  // Relations
  rolePermissions AkRolePermission[]

  @@unique([resource, action])
  @@index([resource])
  @@index([action])
  @@index([isActive])
  @@map("ak_permissions")
}

// Role-Permission relationship (many-to-many)
model AkRolePermission {
  idRolePermission Int      @id @default(autoincrement()) @map("id_role_permission")
  idRole           Int      @map("id_role")
  idPermission     Int      @map("id_permission")
  grantedAt        DateTime @default(now()) @map("granted_at") @db.Timestamp
  grantedBy        Int?     @map("granted_by") // Admin who granted this permission

  // Relations
  role       AkRole       @relation(fields: [idRole], references: [idRole], onDelete: Cascade)
  permission AkPermission @relation(fields: [idPermission], references: [idPermission], onDelete: Cascade)
  grantedByUser SmfMember? @relation(fields: [grantedBy], references: [idMember], onDelete: SetNull)

  @@unique([idRole, idPermission])
  @@index([idRole])
  @@index([idPermission])
  @@map("ak_role_permissions")
}

// User-Role assignments (overrides SMF group-based permissions)
model AkUserRole {
  idUserRole Int      @id @default(autoincrement()) @map("id_user_role")
  idMember   Int      @map("id_member")
  idRole     Int      @map("id_role")
  assignedAt DateTime @default(now()) @map("assigned_at") @db.Timestamp
  assignedBy Int?     @map("assigned_by") // Admin who assigned this role
  expiresAt  DateTime? @map("expires_at") @db.Timestamp  // Optional expiration
  isActive   Boolean  @default(true) @map("is_active")

  // Relations
  member         SmfMember  @relation("UserRoleAssignment", fields: [idMember], references: [idMember], onDelete: Cascade)
  role           AkRole     @relation(fields: [idRole], references: [idRole], onDelete: Cascade)
  assignedByUser SmfMember? @relation("RoleAssignedBy", fields: [assignedBy], references: [idMember], onDelete: SetNull)

  @@unique([idMember, idRole])
  @@index([idMember])
  @@index([idRole])
  @@index([isActive])
  @@index([expiresAt])
  @@map("ak_user_roles")
}

// Admin Activity Log for role/permission changes
model AkRoleAuditLog {
  idLog      Int      @id @default(autoincrement()) @map("id_log")
  idMember   Int      @map("id_member")  // Admin performing the action
  action     String   @db.VarChar(100)   // ROLE_CREATED, PERMISSION_GRANTED, USER_ROLE_ASSIGNED, etc.
  entityType String   @map("entity_type") @db.VarChar(50) // ROLE, PERMISSION, USER_ROLE
  entityId   Int?     @map("entity_id")  // ID of the affected entity
  details    String?  @db.Text           // JSON with additional details
  ipAddress  String?  @map("ip_address") @db.VarChar(45)
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamp

  // Relations
  member SmfMember @relation("RoleAuditLog", fields: [idMember], references: [idMember], onDelete: Cascade)

  @@index([idMember])
  @@index([action])
  @@index([entityType])
  @@index([createdAt])
  @@map("ak_role_audit_logs")
}

// Client-side error logs
model ClientErrorLog {
  id         Int       @id @default(autoincrement())
  message    String    @db.Text
  stack      String?   @db.Text
  statusCode Int?      @map("status_code")
  endpoint   String?   @db.VarChar(500)
  url        String?   @db.Text
  userAgent  String?   @map("user_agent") @db.Text
  userId     Int?      @map("user_id")
  context    Json?     @db.JsonB
  createdAt  DateTime  @default(now()) @map("created_at") @db.Timestamp

  @@index([statusCode])
  @@index([endpoint])
  @@index([userId])
  @@index([createdAt])
  @@map("client_error_logs")
}
